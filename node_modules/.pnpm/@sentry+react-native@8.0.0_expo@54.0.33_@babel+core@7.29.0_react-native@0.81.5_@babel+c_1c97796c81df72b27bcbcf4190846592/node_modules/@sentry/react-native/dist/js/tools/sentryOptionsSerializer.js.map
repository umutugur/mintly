{"version":3,"file":"sentryOptionsSerializer.js","sourceRoot":"","sources":["../../../src/js/tools/sentryOptionsSerializer.ts"],"names":[],"mappings":"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","sourcesContent":["import { logger } from '@sentry/core';\nimport * as fs from 'fs';\nimport type { MetroConfig, Module, ReadOnlyGraph, SerializerOptions } from 'metro';\nimport * as path from 'path';\nimport type { MetroCustomSerializer, VirtualJSOutput } from './utils';\nimport { createSet } from './utils';\n// eslint-disable-next-line import/no-extraneous-dependencies\nimport countLines from './vendor/metro/countLines';\n\nconst DEFAULT_OPTIONS_FILE_NAME = 'sentry.options.json';\n\n/**\n * Loads Sentry options from a file in\n */\nexport function withSentryOptionsFromFile(config: MetroConfig, optionsFile: string | boolean): MetroConfig {\n  if (optionsFile === false) {\n    return config;\n  }\n\n  const { projectRoot } = config;\n  if (!projectRoot) {\n    // eslint-disable-next-line no-console\n    console.error('[@sentry/react-native/metro] Project root is required to load Sentry options from a file');\n    return config;\n  }\n\n  let optionsPath = path.join(projectRoot, DEFAULT_OPTIONS_FILE_NAME);\n  if (typeof optionsFile === 'string' && path.isAbsolute(optionsFile)) {\n    optionsPath = optionsFile;\n  } else if (typeof optionsFile === 'string') {\n    optionsPath = path.join(projectRoot, optionsFile);\n  }\n\n  const originalSerializer = config.serializer?.customSerializer;\n  if (!originalSerializer) {\n    // It's okay to bail here because we don't expose this for direct usage, but as part of `withSentryConfig`\n    // If used directly in RN, the user is responsible for providing a custom serializer first, Expo provides serializer in default config\n    // eslint-disable-next-line no-console\n    console.error(\n      '[@sentry/react-native/metro] `config.serializer.customSerializer` is required to load Sentry options from a file',\n    );\n    return config;\n  }\n\n  const sentryOptionsSerializer: MetroCustomSerializer = (\n    entryPoint: string,\n    preModules: readonly Module[],\n    graph: ReadOnlyGraph,\n    options: SerializerOptions,\n  ) => {\n    const sentryOptionsModule = createSentryOptionsModule(optionsPath);\n    if (sentryOptionsModule) {\n      (preModules as Module[]).push(sentryOptionsModule);\n    }\n    return originalSerializer(entryPoint, preModules, graph, options);\n  };\n\n  return {\n    ...config,\n    serializer: {\n      ...config.serializer,\n      customSerializer: sentryOptionsSerializer,\n    },\n  };\n}\n\nfunction createSentryOptionsModule(filePath: string): Module<VirtualJSOutput> | null {\n  let content: string;\n  try {\n    content = fs.readFileSync(filePath, 'utf8');\n  } catch (error) {\n    if ((error as NodeJS.ErrnoException).code === 'ENOENT') {\n      logger.debug(`[@sentry/react-native/metro] Sentry options file does not exist at ${filePath}`);\n    } else {\n      logger.error(`[@sentry/react-native/metro] Failed to read Sentry options file at ${filePath}`);\n    }\n    return null;\n  }\n\n  let parsedContent: Record<string, unknown>;\n  try {\n    parsedContent = JSON.parse(content);\n  } catch (error) {\n    logger.error(`[@sentry/react-native/metro] Failed to parse Sentry options file at ${filePath}`);\n    return null;\n  }\n\n  const minifiedContent = JSON.stringify(parsedContent);\n  const optionsCode = `var __SENTRY_OPTIONS__=${minifiedContent};`;\n\n  logger.debug(`[@sentry/react-native/metro] Sentry options added to the bundle from file at ${filePath}`);\n  return {\n    dependencies: new Map(),\n    getSource: () => Buffer.from(optionsCode),\n    inverseDependencies: createSet(),\n    path: '__sentry-options__',\n    output: [\n      {\n        type: 'js/script/virtual',\n        data: {\n          code: optionsCode,\n          lineCount: countLines(optionsCode),\n          map: [],\n        },\n      },\n    ],\n  };\n}\n"]}