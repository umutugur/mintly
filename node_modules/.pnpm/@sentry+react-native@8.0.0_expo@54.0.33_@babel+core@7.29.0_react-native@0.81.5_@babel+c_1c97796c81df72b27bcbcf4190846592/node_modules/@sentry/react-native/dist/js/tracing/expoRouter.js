import { SPAN_STATUS_ERROR, SPAN_STATUS_OK, startInactiveSpan } from '@sentry/core';
import { SPAN_ORIGIN_AUTO_EXPO_ROUTER_PREFETCH } from './origin';
/**
 * Wraps Expo Router. It currently only does one thing: extends prefetch() method
 * to add automated performance monitoring.
 *
 * This function instruments the `prefetch` method of an Expo Router instance
 * to create performance spans that measure how long route prefetching takes.
 *
 * @param router - The Expo Router instance from `useRouter()` hook
 * @returns The same router instance with an instrumented prefetch method
 */
export function wrapExpoRouter(router) {
    if (!(router === null || router === void 0 ? void 0 : router.prefetch)) {
        return router;
    }
    // Check if already wrapped to avoid double-wrapping
    if (router.__sentryPrefetchWrapped) {
        return router;
    }
    const originalPrefetch = router.prefetch.bind(router);
    router.prefetch = ((href) => {
        // Extract route name from href for better span naming
        let routeName = 'unknown';
        if (typeof href === 'string') {
            routeName = href;
        }
        else if (href && typeof href === 'object' && 'pathname' in href && href.pathname) {
            routeName = href.pathname;
        }
        const span = startInactiveSpan({
            op: 'navigation.prefetch',
            name: `Prefetch ${routeName}`,
            attributes: {
                'sentry.origin': SPAN_ORIGIN_AUTO_EXPO_ROUTER_PREFETCH,
                'route.href': typeof href === 'string' ? href : JSON.stringify(href),
                'route.name': routeName,
            },
        });
        try {
            const result = originalPrefetch(href);
            // Handle both promise and synchronous returns
            if (result && typeof result === 'object' && 'then' in result && typeof result.then === 'function') {
                return result
                    .then(res => {
                    span === null || span === void 0 ? void 0 : span.setStatus({ code: SPAN_STATUS_OK });
                    span === null || span === void 0 ? void 0 : span.end();
                    return res;
                })
                    .catch((error) => {
                    span === null || span === void 0 ? void 0 : span.setStatus({ code: SPAN_STATUS_ERROR, message: String(error) });
                    span === null || span === void 0 ? void 0 : span.end();
                    throw error;
                });
            }
            else {
                // Synchronous completion
                span === null || span === void 0 ? void 0 : span.setStatus({ code: SPAN_STATUS_OK });
                span === null || span === void 0 ? void 0 : span.end();
                return result;
            }
        }
        catch (error) {
            span === null || span === void 0 ? void 0 : span.setStatus({ code: SPAN_STATUS_ERROR, message: String(error) });
            span === null || span === void 0 ? void 0 : span.end();
            throw error;
        }
    });
    // Mark as wrapped to prevent double-wrapping
    router.__sentryPrefetchWrapped = true;
    return router;
}
//# sourceMappingURL=expoRouter.js.map