{"version":3,"file":"logEnricherIntegration.js","sourceRoot":"","sources":["../../../src/js/integrations/logEnricherIntegration.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable complexity */\nimport type { Integration, Log } from '@sentry/core';\nimport { debug, getCurrentScope, getGlobalScope, getIsolationScope } from '@sentry/core';\nimport type { ReactNativeClient } from '../client';\nimport { NATIVE } from '../wrapper';\n\nconst INTEGRATION_NAME = 'LogEnricher';\n\nexport const logEnricherIntegration = (): Integration => {\n  return {\n    name: INTEGRATION_NAME,\n    setup(client: ReactNativeClient) {\n      client.on('afterInit', () => {\n        cacheLogContext().then(\n          () => {\n            client.on('beforeCaptureLog', (log: Log) => {\n              processLog(log, client);\n            });\n          },\n          reason => {\n            debug.log(reason);\n          },\n        );\n      });\n    },\n  };\n};\n\nlet NativeCache: Record<string, unknown> | undefined = undefined;\n\n/**\n * Sets a log attribute if the value exists and the attribute key is not already present.\n *\n * @param logAttributes - The log attributes object to modify.\n * @param key - The attribute key to set.\n * @param value - The value to set (only sets if not null/undefined and key not present).\n * @param setEvenIfPresent - Whether to set the attribute if it is present. Defaults to true.\n */\nfunction setLogAttribute(\n  logAttributes: Record<string, unknown>,\n  key: string,\n  value: unknown,\n  setEvenIfPresent = true,\n): void {\n  if (value != null && (!logAttributes[key] || setEvenIfPresent)) {\n    logAttributes[key] = value;\n  }\n}\n\nasync function cacheLogContext(): Promise<void> {\n  try {\n    const response = await NATIVE.fetchNativeLogAttributes();\n\n    NativeCache = {\n      ...(response?.contexts?.device && {\n        brand: response.contexts.device?.brand,\n        model: response.contexts.device?.model,\n        family: response.contexts.device?.family,\n      }),\n      ...(response?.contexts?.os && {\n        os: response.contexts.os.name,\n        version: response.contexts.os.version,\n      }),\n      ...(response?.contexts?.release && {\n        release: response.contexts.release,\n      }),\n    };\n  } catch (e) {\n    return Promise.reject(`[LOGS]: Failed to prepare attributes from Native Layer: ${e}`);\n  }\n  return Promise.resolve();\n}\n\nfunction processLog(log: Log, client: ReactNativeClient): void {\n  if (NativeCache === undefined) {\n    return;\n  }\n\n  // Save log.attributes to a new variable\n  const logAttributes = log.attributes ?? {};\n\n  // Apply scope attributes from all active scopes (global, isolation, and current)\n  // These are applied first so they can be overridden by more specific attributes\n  const scopeAttributes = collectScopeAttributes();\n  Object.keys(scopeAttributes).forEach((key: string) => {\n    setLogAttribute(logAttributes, key, scopeAttributes[key], false);\n  });\n\n  // Use setLogAttribute with the variable instead of direct assignment\n  setLogAttribute(logAttributes, 'device.brand', NativeCache.brand);\n  setLogAttribute(logAttributes, 'device.model', NativeCache.model);\n  setLogAttribute(logAttributes, 'device.family', NativeCache.family);\n  setLogAttribute(logAttributes, 'os.name', NativeCache.os);\n  setLogAttribute(logAttributes, 'os.version', NativeCache.version);\n  setLogAttribute(logAttributes, 'sentry.release', NativeCache.release);\n\n  const replay = client.getIntegrationByName<Integration & { getReplayId: () => string | null }>('MobileReplay');\n  setLogAttribute(logAttributes, 'sentry.replay_id', replay?.getReplayId());\n\n  // Set log.attributes to the variable\n  log.attributes = logAttributes;\n}\n\n/**\n * Extracts primitive attributes from a scope and merges them into the target object.\n * Only string, number, and boolean attribute values are included.\n *\n * @param scope - The scope to extract attributes from\n * @param target - The target object to merge attributes into\n */\nfunction extractScopeAttributes(\n  scope: ReturnType<typeof getCurrentScope>,\n  target: Record<string, string | number | boolean>,\n): void {\n  if (scope && typeof scope.getScopeData === 'function') {\n    const scopeAttrs = scope?.getScopeData?.().attributes || {};\n    Object.keys(scopeAttrs).forEach(key => {\n      const value = scopeAttrs[key];\n      if (typeof value === 'string' || typeof value === 'number' || typeof value === 'boolean') {\n        target[key] = value;\n      }\n    });\n  }\n}\n\n/**\n * Collects attributes from all active scopes (global, isolation, and current).\n * Only string, number, and boolean attribute values are supported.\n * Attributes are merged in order of precedence: global < isolation < current.\n *\n * @returns A merged object containing all scope attributes.\n */\nfunction collectScopeAttributes(): Record<string, string | number | boolean> {\n  const attributes: Record<string, string | number | boolean> = {};\n\n  // Collect attributes from all scopes in order of precedence\n  extractScopeAttributes(getGlobalScope(), attributes);\n  extractScopeAttributes(getIsolationScope(), attributes);\n  extractScopeAttributes(getCurrentScope(), attributes);\n\n  return attributes;\n}\n"]}