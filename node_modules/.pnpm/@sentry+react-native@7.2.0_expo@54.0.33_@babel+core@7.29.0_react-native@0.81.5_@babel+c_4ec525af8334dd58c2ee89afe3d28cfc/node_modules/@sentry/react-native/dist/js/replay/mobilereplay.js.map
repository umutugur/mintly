{"version":3,"file":"mobilereplay.js","sourceRoot":"","sources":["../../../src/js/replay/mobilereplay.ts"],"names":[],"mappings":";;;;;;;;;AACA,OAAO,EAAE,KAAK,EAAE,MAAM,cAAc,CAAC;AACrC,OAAO,EAAE,WAAW,EAAE,MAAM,SAAS,CAAC;AACtC,OAAO,EAAE,QAAQ,EAAE,MAAM,sBAAsB,CAAC;AAChD,OAAO,EAAE,QAAQ,EAAE,WAAW,EAAE,MAAM,sBAAsB,CAAC;AAC7D,OAAO,EAAE,MAAM,EAAE,MAAM,YAAY,CAAC;AACpC,OAAO,EAAE,mCAAmC,EAAE,MAAM,YAAY,CAAC;AAEjE,MAAM,CAAC,MAAM,8BAA8B,GAAG,cAAc,CAAC;AAiE7D,MAAM,cAAc,GAAkC;IACpD,WAAW,EAAE,IAAI;IACjB,aAAa,EAAE,IAAI;IACnB,cAAc,EAAE,IAAI;IACpB,8BAA8B,EAAE,KAAK;IACrC,oBAAoB,EAAE,IAAI;IAC1B,uBAAuB,EAAE,KAAK;CAC/B,CAAC;AAEF,SAAS,YAAY,CAAC,WAAyC;IAC7D,MAAM,MAAM,mCACP,cAAc,GACd,WAAW,CACf,CAAC;IAEF,IAAI,WAAW,CAAC,oBAAoB,KAAK,SAAS,IAAI,WAAW,CAAC,8BAA8B,KAAK,SAAS,EAAE;QAC9G,MAAM,CAAC,oBAAoB,GAAG,WAAW,CAAC,8BAA8B,CAAC;KAC1E;IAED,OAAO,MAAM,CAAC;AAChB,CAAC;AAOD;;;;;;;;;;;;;;;GAeG;AACH,MAAM,CAAC,MAAM,uBAAuB,GAAG,CAAC,cAAmC,cAAc,EAA2B,EAAE;IACpH,IAAI,QAAQ,EAAE,EAAE;QACd,KAAK,CAAC,IAAI,CACR,YAAY,8BAA8B,gFAAgF,CAC3H,CAAC;KACH;IACD,IAAI,WAAW,EAAE,EAAE;QACjB,KAAK,CAAC,IAAI,CAAC,YAAY,8BAA8B,qCAAqC,CAAC,CAAC;KAC7F;IAED,IAAI,QAAQ,EAAE,IAAI,WAAW,EAAE,EAAE;QAC/B,OAAO,2BAA2B,EAAE,CAAC;KACtC;IAED,MAAM,OAAO,GAAG,YAAY,CAAC,WAAW,CAAC,CAAC;IAE1C,SAAe,YAAY,CAAC,KAAY;;;YACtC,MAAM,YAAY,GAAG,CAAA,MAAA,KAAK,CAAC,SAAS,0CAAE,MAAM,KAAI,KAAK,CAAC,SAAS,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC;YAClF,IAAI,CAAC,YAAY,EAAE;gBACjB,iDAAiD;gBACjD,OAAO,KAAK,CAAC;aACd;YAED,MAAM,iBAAiB,GAAG,MAAM,CAAC,kBAAkB,EAAE,CAAC;YACtD,IAAI,iBAAiB,EAAE;gBACrB,KAAK,CAAC,GAAG,CACP,YAAY,8BAA8B,oCAAoC,iBAAiB,cAAc,KAAK,CAAC,QAAQ,GAAG,CAC/H,CAAC;gBACF,OAAO,KAAK,CAAC;aACd;YAED,MAAM,QAAQ,GAAG,MAAM,MAAM,CAAC,aAAa,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC;YAChE,IAAI,CAAC,QAAQ,EAAE;gBACb,KAAK,CAAC,GAAG,CAAC,YAAY,8BAA8B,0BAA0B,KAAK,CAAC,QAAQ,GAAG,CAAC,CAAC;gBACjG,OAAO,KAAK,CAAC;aACd;YAED,OAAO,KAAK,CAAC;;KACd;IAED,SAAS,KAAK,CAAC,MAAc;QAC3B,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,EAAE;YACrB,OAAO;SACR;QAED,MAAM,CAAC,EAAE,CAAC,WAAW,EAAE,CAAC,GAA2B,EAAE,EAAE;YACrD,IAAI,GAAG,CAAC,SAAS,EAAE;gBACjB,OAAO;aACR;YAED,6GAA6G;YAC7G,MAAM,eAAe,GAAG,MAAM,CAAC,kBAAkB,EAAE,CAAC;YACpD,IAAI,eAAe,EAAE;gBACnB,GAAG,CAAC,SAAS,GAAG,eAAe,CAAC;aACjC;QACH,CAAC,CAAC,CAAC;QAEH,MAAM,CAAC,EAAE,CAAC,qBAAqB,EAAE,mCAAmC,CAAC,CAAC;IACxE,CAAC;IAED,SAAS,WAAW;QAClB,OAAO,MAAM,CAAC,kBAAkB,EAAE,CAAC;IACrC,CAAC;IAED,iHAAiH;IACjH,8GAA8G;IAC9G,OAAO;QACL,IAAI,EAAE,8BAA8B;QACpC,KAAK;QACL,YAAY;QACZ,OAAO,EAAE,OAAO;QAChB,WAAW,EAAE,WAAW;KACzB,CAAC;AACJ,CAAC,CAAC;AAEF,MAAM,2BAA2B,GAAG,GAA4B,EAAE;IAChE,OAAO;QACL,IAAI,EAAE,8BAA8B;QACpC,OAAO,EAAE,cAAc;QACvB,WAAW,EAAE,GAAG,EAAE,CAAC,IAAI,EAAE,uCAAuC;KACjE,CAAC;AACJ,CAAC,CAAC","sourcesContent":["import type { Client, DynamicSamplingContext, Event, Integration } from '@sentry/core';\nimport { debug } from '@sentry/core';\nimport { isHardCrash } from '../misc';\nimport { hasHooks } from '../utils/clientutils';\nimport { isExpoGo, notMobileOs } from '../utils/environment';\nimport { NATIVE } from '../wrapper';\nimport { enrichXhrBreadcrumbsForMobileReplay } from './xhrUtils';\n\nexport const MOBILE_REPLAY_INTEGRATION_NAME = 'MobileReplay';\n\nexport interface MobileReplayOptions {\n  /**\n   * Mask all text in recordings\n   *\n   * @default true\n   */\n  maskAllText?: boolean;\n\n  /**\n   * Mask all images in recordings\n   *\n   * @default true\n   */\n  maskAllImages?: boolean;\n\n  /**\n   * Mask all vector graphics in recordings\n   * Supports `react-native-svg`\n   *\n   * @default true\n   */\n  maskAllVectors?: boolean;\n\n  /**\n   * Enables the up to 5x faster experimental view renderer used by the Session Replay integration on iOS.\n   *\n   * Enabling this flag will reduce the amount of time it takes to render each frame of the session replay on the main thread, therefore reducing\n   * interruptions and visual lag.\n   *\n   * - Experiment: This is an experimental feature and is therefore disabled by default.\n   *\n   * @deprecated Use `enableViewRendererV2` instead.\n   */\n  enableExperimentalViewRenderer?: boolean;\n\n  /**\n   * Enables up to 5x faster new view renderer used by the Session Replay integration on iOS.\n   *\n   * Enabling this flag will reduce the amount of time it takes to render each frame of the session replay on the main thread, therefore reducing\n   * interruptions and visual lag. [Our benchmarks](https://github.com/getsentry/sentry-cocoa/pull/4940) have shown a significant improvement of\n   * **up to 4-5x faster rendering** (reducing `~160ms` to `~36ms` per frame) on older devices.\n   *\n   * - Experiment: In case you are noticing issues with the new view renderer, please report the issue on [GitHub](https://github.com/getsentry/sentry-cocoa).\n   *               Eventually, we will remove this feature flag and use the new view renderer by default.\n   *\n   * @default true\n   */\n  enableViewRendererV2?: boolean;\n\n  /**\n   * Enables up to 5x faster but incomplete view rendering used by the Session Replay integration on iOS.\n   *\n   * Enabling this flag will reduce the amount of time it takes to render each frame of the session replay on the main thread, therefore reducing\n   * interruptions and visual lag.\n   *\n   * - Note: This flag can only be used together with `enableExperimentalViewRenderer` with up to 20% faster render times.\n   * - Experiment: This is an experimental feature and is therefore disabled by default.\n   *\n   * @default false\n   */\n  enableFastViewRendering?: boolean;\n}\n\nconst defaultOptions: Required<MobileReplayOptions> = {\n  maskAllText: true,\n  maskAllImages: true,\n  maskAllVectors: true,\n  enableExperimentalViewRenderer: false,\n  enableViewRendererV2: true,\n  enableFastViewRendering: false,\n};\n\nfunction mergeOptions(initOptions: Partial<MobileReplayOptions>): Required<MobileReplayOptions> {\n  const merged = {\n    ...defaultOptions,\n    ...initOptions,\n  };\n\n  if (initOptions.enableViewRendererV2 === undefined && initOptions.enableExperimentalViewRenderer !== undefined) {\n    merged.enableViewRendererV2 = initOptions.enableExperimentalViewRenderer;\n  }\n\n  return merged;\n}\n\ntype MobileReplayIntegration = Integration & {\n  options: Required<MobileReplayOptions>;\n  getReplayId: () => string | null;\n};\n\n/**\n * The Mobile Replay Integration, let's you adjust the default mobile replay options.\n * To be passed to `Sentry.init` with `replaysOnErrorSampleRate` or `replaysSessionSampleRate`.\n *\n * ```javascript\n * Sentry.init({\n *  replaysOnErrorSampleRate: 1.0,\n *  replaysSessionSampleRate: 1.0,\n *  integrations: [mobileReplayIntegration({\n *    // Adjust the default options\n *  })],\n * });\n * ```\n *\n * @experimental\n */\nexport const mobileReplayIntegration = (initOptions: MobileReplayOptions = defaultOptions): MobileReplayIntegration => {\n  if (isExpoGo()) {\n    debug.warn(\n      `[Sentry] ${MOBILE_REPLAY_INTEGRATION_NAME} is not supported in Expo Go. Use EAS Build or \\`expo prebuild\\` to enable it.`,\n    );\n  }\n  if (notMobileOs()) {\n    debug.warn(`[Sentry] ${MOBILE_REPLAY_INTEGRATION_NAME} is not supported on this platform.`);\n  }\n\n  if (isExpoGo() || notMobileOs()) {\n    return mobileReplayIntegrationNoop();\n  }\n\n  const options = mergeOptions(initOptions);\n\n  async function processEvent(event: Event): Promise<Event> {\n    const hasException = event.exception?.values && event.exception.values.length > 0;\n    if (!hasException) {\n      // Event is not an error, will not capture replay\n      return event;\n    }\n\n    const recordingReplayId = NATIVE.getCurrentReplayId();\n    if (recordingReplayId) {\n      debug.log(\n        `[Sentry] ${MOBILE_REPLAY_INTEGRATION_NAME} assign already recording replay ${recordingReplayId} for event ${event.event_id}.`,\n      );\n      return event;\n    }\n\n    const replayId = await NATIVE.captureReplay(isHardCrash(event));\n    if (!replayId) {\n      debug.log(`[Sentry] ${MOBILE_REPLAY_INTEGRATION_NAME} not sampled for event ${event.event_id}.`);\n      return event;\n    }\n\n    return event;\n  }\n\n  function setup(client: Client): void {\n    if (!hasHooks(client)) {\n      return;\n    }\n\n    client.on('createDsc', (dsc: DynamicSamplingContext) => {\n      if (dsc.replay_id) {\n        return;\n      }\n\n      // TODO: For better performance, we should emit replayId changes on native, and hold the replayId value in JS\n      const currentReplayId = NATIVE.getCurrentReplayId();\n      if (currentReplayId) {\n        dsc.replay_id = currentReplayId;\n      }\n    });\n\n    client.on('beforeAddBreadcrumb', enrichXhrBreadcrumbsForMobileReplay);\n  }\n\n  function getReplayId(): string | null {\n    return NATIVE.getCurrentReplayId();\n  }\n\n  // TODO: When adding manual API, ensure overlap with the web replay so users can use the same API interchangeably\n  // https://github.com/getsentry/sentry-javascript/blob/develop/packages/replay-internal/src/integration.ts#L45\n  return {\n    name: MOBILE_REPLAY_INTEGRATION_NAME,\n    setup,\n    processEvent,\n    options: options,\n    getReplayId: getReplayId,\n  };\n};\n\nconst mobileReplayIntegrationNoop = (): MobileReplayIntegration => {\n  return {\n    name: MOBILE_REPLAY_INTEGRATION_NAME,\n    options: defaultOptions,\n    getReplayId: () => null, // Mock implementation for noop version\n  };\n};\n"]}